L.Layer.Highlight=L.Layer.extend({_data:void 0,_initOpt:{},_otherOpt:void 0,_searchOpt:void 0,_layers:[],onAdd:function(t){if(this._data){let e=L.geoJSON(this._data,this._otherOpt);void 0!==this._otherOpt.eventHandlers&&Object.keys(this._otherOpt.eventHandlers).forEach(t=>{e.on(t,this._otherOpt.eventHandlers[t])}),this._layers.push(e.addTo(t))}else setTimeout((function(){this.onAdd(t)}).bind(this),1e3)},initialize:function(t){t&&t.email&&(this._initOpt.email=t.email),t&&t.nominatimAPI&&(this._initOpt.nominatimAPI=t.nominatimAPI)},do:function(t,e={}){return this._handleOpts(t,e),this._getHighlightData({street:t.street,city:t.city,q:t.q}),this},onRemove:function(t){this._layers.forEach(t=>t.removeFrom(this._map))},_getHighlightData:function(t){this._getBatch(t,this).then((function(e){this._getBatchHandleResult(e,t)}).bind(this),(function(t){console.error(t)}).bind(this))},_getBatchHandleResult:function(t,e){let i=0,s=[];if(this._searchOpt.limit>1)for(;this._filter(t).features.length%this._searchOpt.limit==0&&(e.exclude=t.features.map(t=>t.properties.place_id),s.push(this._getBatch(e,this)),!(++i>10)););s.length>0&&Promise.all(s).then(function(e){e.forEach(function(e){t.features=t.features.concat(e.features)})}),this._cleanup(t,e)},_getBatch:(function(t,e){return new Promise(function(i,s){var n=new XMLHttpRequest;n.onload=(function(){200==n.status?i(JSON.parse(n.responseText)):s({status:n.status,statusText:n.statusText})}).bind(this),n.open("GET",(e._initOpt.nominatimAPI?e._initOpt.nominatimAPI:"https://nominatim.openstreetmap.org")+"/search?"+e._encodeQueryData(t),!0),n.setRequestHeader("Accept","application/json"),n.send(null)})}).bind(this),_handleOpts:function(t,e){if(!t||!t.q&&!t.city&&!t.street)throw Error("Empty search in L.Highlight constructor.");(null==t.filter||void 0==t.filter)&&(t.filter="LineString"),(null==t.limit||void 0==t.limit)&&(t.limit=50),e.style||(e.style=function(t){return{color:"#0040ff",opacity:1}}),this._searchOpt=t,this._otherOpt=e},_cleanup:function(t){this._searchOpt.filter&&(t.features=t.features.filter(t=>t.geometry.type==this._searchOpt.filter)),t=this._filter(t),this._data=t},_filter:function(t){return this._searchOpt.city&&(t.features=t.features.filter(t=>t.properties.address.city==this._searchOpt.city||t.properties.address.town==this._searchOpt.city||t.properties.address.county==this._searchOpt.city)),this._searchOpt.street&&(t.features=t.features.filter(t=>t.properties.address.road==this._searchOpt.street)),t},_encodeQueryData:function(t){let e=[],i={exclude_place_ids:t.exclude?t.exclude.join(","):"",format:"geojson",polygon_geojson:1,dedupe:0,limit:this._searchOpt.limit,addressdetails:1,polygon_geojson:1,email:this._initOpt.email?this._initOpt.email:""};for(let s in t.q?i.q=t.q:(i.street=t.street,i.city=t.city),i)e.push(encodeURIComponent(s)+"="+encodeURIComponent(i[s]));return e.join("&")}});